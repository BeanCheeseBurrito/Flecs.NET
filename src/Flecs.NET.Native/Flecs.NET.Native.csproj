<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <OutputType>Library</OutputType>
        <TargetFramework>netstandard2.1</TargetFramework>

        <!-- This is project for holding natives only so we dont really want to generate anything else -->
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
        <AppendRuntimeIdentifierToOutputPath>false</AppendRuntimeIdentifierToOutputPath>
        <IncludeSymbols>false</IncludeSymbols>
        <IncludeBuildFiles>false</IncludeBuildFiles>
        <IncludeBuildOutput>false</IncludeBuildOutput>
        <MSBuildEnableWorkloadResolver>false</MSBuildEnableWorkloadResolver>
        <NoWarn>$(NoWarn);CS2008</NoWarn>
    </PropertyGroup>

    <PropertyGroup>
        <IsPackable>true</IsPackable>

        <VersionPrefix>4.0.2</VersionPrefix>
        <Authors>BeanCheeseBurrito</Authors>
        <Copyright>BeanCheeseBurrito</Copyright>
        <Description>Native libraries for flecs</Description>
        <PackageProjectUrl>https://github.com/BeanCheeseBurrito/Flecs.NET</PackageProjectUrl>
        <PackageIconUrl>https://raw.githubusercontent.com/SanderMertens/flecs/master/docs/img/logo_small.png</PackageIconUrl>
        <PackageLicenseExpression>MIT</PackageLicenseExpression>
        <RepositoryUrl>https://github.com/BeanCheeseBurrito/Flecs.NET</RepositoryUrl>
        <RepositoryType>Github</RepositoryType>
        <PackageRequireLicenseAcceptance>true</PackageRequireLicenseAcceptance>
    </PropertyGroup>

    <PropertyGroup>
        <HostArch>$([System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture)</HostArch>
    </PropertyGroup>

    <!-- We want 2 separate natives packages for debug and release modes -->
    <Choose>
        <When Condition="'$(Configuration)' == 'Debug'">
            <PropertyGroup>
                <PackageId>Flecs.NET.Native.Debug</PackageId>
                <Title>$(PackageId)</Title>
                <ZigConfiguration>Debug</ZigConfiguration>
            </PropertyGroup>
        </When>
        <When Condition="'$(Configuration)' == 'Release'">
            <PropertyGroup>
                <PackageId>Flecs.NET.Native.Release</PackageId>
                <Title>$(PackageId)</Title>
                <ZigConfiguration>ReleaseFast</ZigConfiguration>
            </PropertyGroup>
        </When>
    </Choose>

    <!-- As we are cross-compiling, RID != host runtime so we need to determine it for later -->
    <Choose>
        <When Condition="$([MSBuild]::IsOSPlatform('Windows'))">
            <PropertyGroup>
                <HostRuntime Condition="'$(HostArch)' == 'X64'">win-x64</HostRuntime>
                <HostRuntime Condition="'$(HostArch)' == 'Arm64'">win-arm64</HostRuntime>
            </PropertyGroup>
        </When>
        <When Condition="$([MSBuild]::IsOSPlatform('Linux'))">
            <PropertyGroup>
                <HostRuntime Condition="'$(HostArch)' == 'X64'">linux-x64</HostRuntime>
                <HostRuntime Condition="'$(HostArch)' == 'Arm64'">linux-arm64</HostRuntime>
            </PropertyGroup>
        </When>
        <When Condition="$([MSBuild]::IsOSPlatform('OSX'))">
            <PropertyGroup>
                <HostRuntime Condition="'$(HostArch)' == 'X64'">osx-x64</HostRuntime>
                <HostRuntime Condition="'$(HostArch)' == 'Arm64'">osx-arm64</HostRuntime>
            </PropertyGroup>
        </When>
    </Choose>

    <!-- Fallback to host runtime when not specified -->
    <PropertyGroup>
        <RuntimeIdentifier Condition="'$(RuntimeIdentifier)' == ''">$(HostRuntime)</RuntimeIdentifier>
    </PropertyGroup>

    <!-- These files will be auto included based on platform in dependant projects -->
    <ItemGroup>
        <None Pack="true" Include="buildTransitive/Flecs.NET.Native.props" PackagePath="buildTransitive/$(PackageId).props"/>
        <None Pack="true" Include="buildTransitive/Flecs.NET.Native.targets" PackagePath="buildTransitive/$(PackageId).targets"/>
        <None Pack="true" Include="$(OutputPath)runtimes/**/*.a;$(OutputPath)runtimes/**/*.lib" PackagePath="static/" />

        <Content Include="$(OutputPath)runtimes/**/**" Exclude="$(OutputPath)runtimes/**/*.a;$(OutputPath)runtimes/**/*.lib" Link="%(Filename)%(Extension)" >
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            <PackagePath>runtimes/</PackagePath>
        </Content>
    </ItemGroup>

    <!-- Determine mapping between dotnet RID and zig targets -->
    <Choose>
        <When Condition="$(RuntimeIdentifier) == 'win-x64'">
            <PropertyGroup>
                <ZigIdentifier>x86_64-windows-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'win-x86'">
            <PropertyGroup>
                <ZigIdentifier>x86-windows-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'win-arm'">
            <PropertyGroup>
                <ZigIdentifier>arm-windows-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'win-arm64'">
            <PropertyGroup>
                <ZigIdentifier>aarch64-windows-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'linux-x64'">
            <PropertyGroup>
                <ZigIdentifier>x86_64-linux-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'linux-x86'">
            <PropertyGroup>
                <ZigIdentifier>x86-linux-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'linux-arm'">
            <PropertyGroup>
                <ZigIdentifier>arm-linux-gnueabihf</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'linux-arm64'">
            <PropertyGroup>
                <ZigIdentifier>aarch64-linux-gnu</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'osx-x64'">
            <PropertyGroup>
                <ZigIdentifier>x86_64-macos</ZigIdentifier>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'osx-arm64'">
            <PropertyGroup>
                <ZigIdentifier>aarch64-macos</ZigIdentifier>
            </PropertyGroup>
            </When>
        <When Condition="$(RuntimeIdentifier) == 'iossimulator-x64'">
            <PropertyGroup>
                <ZigIdentifier>x86_64-ios-simulator</ZigIdentifier>
                <ZigArgs>--sysroot $(IOS_SIMULATOR_SDK)</ZigArgs>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'iossimulator-arm64'">
            <PropertyGroup>
                <ZigIdentifier>aarch64-ios-simulator</ZigIdentifier>
                <ZigArgs>--sysroot $(IOS_SIMULATOR_SDK)</ZigArgs>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'ios-arm64'">
            <PropertyGroup>
                <ZigIdentifier>aarch64-ios</ZigIdentifier>
                <ZigArgs>--sysroot $(IOS_SDK)</ZigArgs>
            </PropertyGroup>
        </When>
        <When Condition="$(RuntimeIdentifier) == 'browser-wasm'">
            <PropertyGroup>
                <ZigIdentifier>wasm32-emscripten</ZigIdentifier>
                <ZigArgs>--sysroot "$(EMSDK)/upstream/emscripten"</ZigArgs>
            </PropertyGroup>
        </When>
        <Otherwise>
            <PropertyGroup>
                <ZigIdentifier>$(RuntimeIdentifier)</ZigIdentifier>
            </PropertyGroup>
        </Otherwise>
    </Choose>

    <!-- Enable soft asserts if configured -->
    <PropertyGroup>
        <ZigArgs Condition="'$(FlecsSoftAssert)' == 'True'">$(ZigArgs) -Dsoft-assert=true</ZigArgs>
    </PropertyGroup>

    <!-- Here we need host not target toolset to compile/cross-compile -->
    <ItemGroup>
        <PackageReference Include="Vezel.Zig.Toolsets.$(HostRuntime)" Version="0.13.0.1">
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
            <PrivateAssets>all</PrivateAssets>
        </PackageReference>
    </ItemGroup>

    <!-- All the native code compile magic lives here -->
    <Target Name="CompileNatives" AfterTargets="Build" Condition="'$(SkipNatives)' != 'true'">
        <Message Importance="High" Text="Build Target: $(RuntimeIdentifier) $(Configuration)"/>
        <Message Importance="High" Text="Build Zig Target: $(ZigIdentifier) $(ZigConfiguration)"/>
        <Message Importance="High" Text="Build Zig Args: $(ZigArgs)"/>
        <Exec Command="$(ZigExePath) build -Doptimize=$(ZigConfiguration) --prefix $(OutputPath)runtimes --prefix-lib-dir $(RuntimeIdentifier)/native --prefix-exe-dir $(RuntimeIdentifier)/native -Dtarget=$(ZigIdentifier) $(ZigArgs)"/>
    </Target>
</Project>
